<?prg
#include "lib/tweb/tweb.ch" 

LOCAL o, oWeb, hCredentials

//	Auth system...
if ! Authorization()
    return nil
endif

//	-------------------------
hCredentials := USession( 'credentials' )

DEFINE WEB oWeb TITLE 'Sistema de Gestión de Cilindros'

    // Incluir la barra lateral
		HTML oWeb FILE 'components/sidebar.html' PARAMS oWeb, 'Inicio', hCredentials

    DEFINE FORM o ID 'myform' API 'api_folder' OF oWeb
        o:lFluid := .t.

				
    
    INIT FORM o

		

							
						//HTML o 
						//<button type="button" class="btn btn-primary" data-live data-onclick="recepcion" onclick="openTabFromSidebar('recepcion','Cilindros')" id=myform-btn1>Abrir Módulo Cilindros</button>
						//ENDTEXT


        // Contenedor principal para el sistema de pestañas
        DIV o ID 'tabsContainer' CLASS 'folder-content' STYLE 'flex:1;display:flex;flex-direction:column;height:calc(100vh - 60px);'
            DIV o CLASS 'content-area' STYLE 'flex:1;display:flex;flex-direction:column;'
                DIV o CLASS 'main-content' STYLE 'flex:1;display:flex;flex-direction:column;'
                    // Definimos un DIV contenedor para las pestañas dinámicas
                    DIV o ID 'tabsSystem' STYLE 'display:flex;flex-direction:column;height:100%;'
                        // Estructura de pestañas que será manipulada por JavaScript
                        HTML o INLINE '<ul class="nav nav-tabs" id="tabList" role="tablist"></ul>'	
                        HTML o INLINE '<div class="tab-content" id="tabContent" style="flex:1;height:calc(100% - 42px);"></div>'
                    ENDDIV o
                ENDDIV o
            ENDDIV o
        ENDDIV o

        // JavaScript para la funcionalidad de pestañas dinámicas
        HTML o

            <script>
							// Sistema de pestañas dinámicas
							document.addEventListener('DOMContentLoaded', function () {
								var tabCounter = 0;
								var defaultBg = '#f8f9fa';
								var colors = ['#e3f2fd', '#fce4ec', '#e8f5e9', '#fff3e0', '#f3e5f5', '#e0f7fa', '#f9fbe7'];

								var tabList = document.getElementById('tabList');
								var tabContent = document.getElementById('tabContent');

								console.log('Elementos detectados:', {
									tabList: tabList,
									tabContent: tabContent
								});

								function activarTab(btn) {
									if (!btn) return;
									tabList.querySelectorAll('.nav-link').forEach(function (b) { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
									tabContent.querySelectorAll('.tab-pane').forEach(function (p) { p.classList.remove('show', 'active'); });
									btn.classList.add('active'); btn.setAttribute('aria-selected', 'true');
									var paneId = btn.getAttribute('data-target');
									var pane = document.getElementById(paneId);
									if (pane) pane.classList.add('show', 'active');
									// No set background color on tabContent to keep parent styles (removed inline background)
								}

								// Crear una pestaña recuperando HTML mediante fetch y mostrando el fragmento directamente
								window.addFetchedTab = function (url, customId, title, makeActive) {
									console.log("Creando pestaña con fetch para URL:", url);
									tabCounter++; var idx = tabCounter;
									var tabId = customId || ('tab-fet-' + idx);
									// Asignar color a la pestaña usando el array colors (ciclo)
									var color = colors[(idx - 1) % colors.length] || defaultBg;
									var paneId = tabId + '-pane';
									var li = document.createElement('li'); li.className = 'nav-item'; li.setAttribute('role', 'presentation');
									var btnTab = document.createElement('button');
									btnTab.className = 'nav-link'; btnTab.type = 'button'; btnTab.id = tabId + '-btn';
									btnTab.setAttribute('role', 'tab'); btnTab.setAttribute('aria-controls', paneId);
									btnTab.setAttribute('aria-selected', 'false'); btnTab.setAttribute('data-target', paneId);
									// Guardar el color en un atributo y aplicarlo visualmente (pequeña franja)
									btnTab.setAttribute('data-color', color);
									btnTab.style.backgroundColor = color;
									btnTab.style.borderLeft = '4px solid ' + color;
									btnTab.innerHTML = '<span>' + (title || 'Tab') + '</span><span class="tab-close" title="Cerrar">&times;</span>';

									btnTab.addEventListener('click', function (e) { if (e.target.classList.contains('tab-close')) return; activarTab(btnTab); });
									btnTab.querySelector('.tab-close').addEventListener('click', function (e) { e.stopPropagation(); if (confirm('¿Deseas cerrar "' + (title || tabId) + '"?')) { li.remove(); var paneToRemove = document.getElementById(paneId); if (paneToRemove) paneToRemove.remove(); var first = tabList.querySelector('.nav-link'); if (first) activarTab(first); else tabContent.style.backgroundColor = defaultBg; } });

									li.appendChild(btnTab); tabList.appendChild(li);

									var pane = document.createElement('div');
									pane.className = 'tab-pane fade'; pane.id = paneId; pane.setAttribute('role', 'tabpanel'); pane.setAttribute('aria-labelledby', btnTab.id);
									pane.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
									tabContent.appendChild(pane);

									// Fetch the fragment and insert it into the pane (no iframe)
									fetch(url, { credentials: 'same-origin' }).then(function (res) {
										if (!res.ok) throw new Error('HTTP ' + res.status + ' - ' + res.statusText);
										return res.text();
									}).then(function (html) {
										// Insert raw HTML fragment into the pane. This will render within the parent's document
										pane.innerHTML = html;

										// Execute any scripts that were in the loaded HTML
										var scripts = pane.querySelectorAll('script');
										scripts.forEach(function (oldScript) {
											var newScript = document.createElement('script');
											// Copy attributes
											Array.from(oldScript.attributes).forEach(function (attr) {
												newScript.setAttribute(attr.name, attr.value);
											});
											// Copy content
											newScript.appendChild(document.createTextNode(oldScript.innerHTML));
											// Replace old script with new one to trigger execution
											oldScript.parentNode.replaceChild(newScript, oldScript);
										});

										if (makeActive) activarTab(btnTab);
									}).catch(function (err) {
										pane.innerHTML = '<div class="alert alert-danger m-3">Error cargando módulo: ' + err.message + '</div>';
										console.error('addFetchedTab error:', err);
										if (makeActive) activarTab(btnTab);
									});
								}

								// Crear una pestaña con contenido HTML personalizado
								window.addCustomTab = function (html, title, makeActive) {
									tabCounter++; var idx = tabCounter;
									var tabId = 'tab-custom-' + idx;
									var paneId = tabId + '-pane';
									// Asignar color a la pestaña usando el array colors (ciclo)
									var color = colors[(idx - 1) % colors.length] || defaultBg;
									var li = document.createElement('li'); li.className = 'nav-item'; li.setAttribute('role', 'presentation');
									var btnTab = document.createElement('button');
									btnTab.className = 'nav-link'; btnTab.type = 'button'; btnTab.id = tabId + '-btn';
									btnTab.setAttribute('role', 'tab'); btnTab.setAttribute('aria-controls', paneId);
									btnTab.setAttribute('aria-selected', 'false'); btnTab.setAttribute('data-target', paneId);
									// Guardar el color y aplicarlo visualmente
									btnTab.setAttribute('data-color', color);
									btnTab.style.backgroundColor = color;
									btnTab.style.borderLeft = '4px solid ' + color;
									btnTab.innerHTML = '<span>' + (title || 'Tab ' + idx) + '</span><span class="tab-close" title="Cerrar">&times;</span>';

									btnTab.addEventListener('click', function (e) { if (e.target.classList.contains('tab-close')) return; activarTab(btnTab); });
									btnTab.querySelector('.tab-close').addEventListener('click', function (e) { e.stopPropagation(); if (confirm('¿Deseas cerrar "' + (title || tabId) + '"?')) { li.remove(); var paneToRemove = document.getElementById(paneId); if (paneToRemove) paneToRemove.remove(); var first = tabList.querySelector('.nav-link'); if (first) activarTab(first); else tabContent.style.backgroundColor = defaultBg; } });

									li.appendChild(btnTab); tabList.appendChild(li);

									var pane = document.createElement('div');
									pane.className = 'tab-pane fade'; pane.id = paneId; pane.setAttribute('role', 'tabpanel'); pane.setAttribute('aria-labelledby', btnTab.id);
									pane.innerHTML = html;
									tabContent.appendChild(pane);

									if (makeActive) activarTab(btnTab);
								}

								// Event listeners para los botones
								tabContent.addEventListener('click', function (e) {
									if (e.target.classList.contains('btn-success')) {
										var group = e.target.closest('.input-group');
										var input = group ? group.querySelector('input') : null;
										var pane = e.target.closest('.tab-pane');
										var tabIndex = pane ? pane.id.replace('pane-', '') : '?';
										var value = input ? input.value : '';
										alert('Valor en Tab ' + tabIndex + ': ' + value);
									}
								});

								// Función para abrir módulos desde el sidebar
								window.openTabFromSidebar = function (modulo, titulo) {
									console.log("Abriendo tab desde sidebar:", modulo, titulo);

									// Verificar si ya existe una pestaña con este ID
									var tabId = modulo + '-tab';
									var existingTab = document.getElementById(tabId + '-btn');

									if (existingTab) {
										// Si la pestaña ya existe, solo la activamos
										console.log("La pestaña ya existe, activándola...");
										activarTab(existingTab);
										return;
									}

									// Si no existe, creamos una nueva pestaña cargando el contenido por fetch
									console.log("Creando nueva pestaña para", modulo);

									// Construir la URL para el fetch apuntando a la ruta pública registrada en el servidor
									// (el servidor tiene: oServer:Route( 'recepcion', 'recepcion' ) )
									var url = modulo;
									console.log("URL del servidor:", url);

									// Usar la función addFetchedTab para insertar fragmentos (sin iframe)
									addFetchedTab(url, tabId, titulo, true);
								}

								// Aviso antes de salir si hay pestañas abiertas
								window.addEventListener('beforeunload', function (e) {
									if (tabList.querySelectorAll('.nav-link').length > 0) {
										e.preventDefault();
										e.returnValue = '';
									}
								});

								// Función para abrir la vista de home_cilindros (vistas locales). Usamos addCustomTab
								window.abrirModulo = function (modulo, titulo) {
									// Verificar si ya existe una pestaña con este ID
									var tabId = modulo + '-tab';
									var existingTab = document.getElementById(tabId + '-btn');

									if (existingTab) {
										// Si la pestaña ya existe, solo la activamos
										console.log("La pestaña de vista ya existe, activándola...");
										activarTab(existingTab);
										return;
									}

									// Cargamos la vista local y la insertamos como HTML (no iframe)
									fetch('views/' + modulo + '.html', { credentials: 'same-origin' }).then(function (res) {
										if (!res.ok) throw new Error('HTTP ' + res.status + ' - ' + res.statusText);
										return res.text();
									}).then(function (html) {
										// Crear pestaña personalizada con ID específico
										tabCounter++; var idx = tabCounter;
										var paneId = tabId + '-pane';
										var color = colors[(idx - 1) % colors.length] || defaultBg;
										var li = document.createElement('li'); li.className = 'nav-item'; li.setAttribute('role', 'presentation');
										var btnTab = document.createElement('button');
										btnTab.className = 'nav-link'; btnTab.type = 'button'; btnTab.id = tabId + '-btn';
										btnTab.setAttribute('role', 'tab'); btnTab.setAttribute('aria-controls', paneId);
										btnTab.setAttribute('aria-selected', 'false'); btnTab.setAttribute('data-target', paneId);
										btnTab.setAttribute('data-color', color);
										btnTab.style.backgroundColor = color;
										btnTab.style.borderLeft = '4px solid ' + color;
										btnTab.innerHTML = '<span>' + titulo + '</span><span class="tab-close" title="Cerrar">&times;</span>';

										btnTab.addEventListener('click', function (e) { if (e.target.classList.contains('tab-close')) return; activarTab(btnTab); });
										btnTab.querySelector('.tab-close').addEventListener('click', function (e) { e.stopPropagation(); if (confirm('¿Deseas cerrar "' + titulo + '"?')) { li.remove(); var paneToRemove = document.getElementById(paneId); if (paneToRemove) paneToRemove.remove(); var first = tabList.querySelector('.nav-link'); if (first) activarTab(first); else tabContent.style.backgroundColor = defaultBg; } });

										li.appendChild(btnTab); tabList.appendChild(li);

										var pane = document.createElement('div');
										pane.className = 'tab-pane fade'; pane.id = paneId; pane.setAttribute('role', 'tabpanel'); pane.setAttribute('aria-labelledby', btnTab.id);
										pane.innerHTML = html;

										// Execute any scripts that were in the loaded HTML
										var scripts = pane.querySelectorAll('script');
										scripts.forEach(function (oldScript) {
											var newScript = document.createElement('script');
											// Copy attributes
											Array.from(oldScript.attributes).forEach(function (attr) {
												newScript.setAttribute(attr.name, attr.value);
											});
											// Copy content
											newScript.appendChild(document.createTextNode(oldScript.innerHTML));
											// Replace old script with new one to trigger execution
											oldScript.parentNode.replaceChild(newScript, oldScript);
										});

										tabContent.appendChild(pane);

										activarTab(btnTab);
									}).catch(function (err) {
										console.error('Error cargando vista:', err);
										// Crear pestaña de error con ID específico
										tabCounter++; var idx = tabCounter;
										var paneId = tabId + '-pane';
										var color = colors[(idx - 1) % colors.length] || defaultBg;
										var li = document.createElement('li'); li.className = 'nav-item'; li.setAttribute('role', 'presentation');
										var btnTab = document.createElement('button');
										btnTab.className = 'nav-link'; btnTab.type = 'button'; btnTab.id = tabId + '-btn';
										btnTab.setAttribute('role', 'tab'); btnTab.setAttribute('aria-controls', paneId);
										btnTab.setAttribute('aria-selected', 'false'); btnTab.setAttribute('data-target', paneId);
										btnTab.setAttribute('data-color', color);
										btnTab.style.backgroundColor = color;
										btnTab.style.borderLeft = '4px solid ' + color;
										btnTab.innerHTML = '<span>' + titulo + ' (Error)</span><span class="tab-close" title="Cerrar">&times;</span>';

										btnTab.addEventListener('click', function (e) { if (e.target.classList.contains('tab-close')) return; activarTab(btnTab); });
										btnTab.querySelector('.tab-close').addEventListener('click', function (e) { e.stopPropagation(); if (confirm('¿Deseas cerrar "' + titulo + '"?')) { li.remove(); var paneToRemove = document.getElementById(paneId); if (paneToRemove) paneToRemove.remove(); var first = tabList.querySelector('.nav-link'); if (first) activarTab(first); else tabContent.style.backgroundColor = defaultBg; } });

										li.appendChild(btnTab); tabList.appendChild(li);

										var pane = document.createElement('div');
										pane.className = 'tab-pane fade'; pane.id = paneId; pane.setAttribute('role', 'tabpanel'); pane.setAttribute('aria-labelledby', btnTab.id);
										pane.innerHTML = '<div class="alert alert-danger m-3">Error cargando vista: ' + err.message + '</div>';
										tabContent.appendChild(pane);

										activarTab(btnTab);
									});
								}
							});
						</script>
        ENDTEXT

    ENDFORM o

INIT WEB oWeb RETURN
?>