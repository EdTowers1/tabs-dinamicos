<?prg
#include "./lib/tweb/tweb.ch"

local o, oWeb, cId, aData, bData, cAccionesHtml

// data de pruebas

local aColumnas := { ;
    { 'title' => "# Documento", 'field' => "DOCTO", 'widthGrow' => 1 }, ;
    { 'title' => "Fecha", 'field' => "FECHA", 'widthGrow' => 1 }, ;
    { 'title' => "Cliente", 'field' => "NOMCLI", 'widthGrow' => 2 };
    }

local bColumnas := { ;
    { 'title' => "Código", 'field' => "CODIGO", 'widthGrow' => 1 }, ;
    { 'title' => "Cantidad", 'field' => "CANTIDAD", 'widthGrow' => 1 }, ;
    { 'title' => "Precio", 'field' => "PRECIO", 'widthGrow' => 1 }, ;
    {'title' => "editar", 'field' => "EDITAR", 'widthGrow' => 1, 'hozAlign' => 'right', 'headerSort' => .F., 'formatter' => 'editbutton'},;
    {'title' => "borrar", 'field' => "BORRAR", 'widthGrow' => 1, 'hozAlign' => 'right', 'headerSort' => .F., 'formatter' => 'deletebutton'} ;
    }


local aOptions := { ;
    'index' => 'ROW_ID', ;
    'selectable' => .T., ;
    'selectableRollingSelection' => .T., ;
    'selectableRangeMode' => "click", ;
    'movableColumns' => .F. ;
    }

local bOptions := { ;
    'index' => 'ROW_ID', ;
    'height' => '250px', ;
    'layout' => 'fitColumns', ;
    'selectable' => .T., ;
    'selectableRollingSelection' => .T., ;
    'selectableRangeMode' => "click", ;
    'movableColumns' => .F. ;
    }

local aEvents := { ;
    { 'name' => 'tableBuilt' , 'proc' => 'exe_consulta' }, ;
    { 'name' => 'rowClick' , 'proc' => 'sincronizar' } ;
    }


local aBotonesHeader := { ;
    { 'id' => 'btn_save_header', 'action' => 'guardar', 'class' => 'btn-primary', 'icon' => 'fas fa-save', 'label' => 'Guardar' }, ;
    { 'id' => 'btn_cancel_header', 'link' => 'recepcion', 'class' => 'btn-secondary', 'icon' => 'fas fa-times', 'label' => 'Cancelar' } ;
    }



DEFINE DIALOG oWeb 

DEFINE FORM o ID 'home_cilindros' API 'api_home_cilindros' OF oWeb
o:lFluid := .t.
INIT FORM o

DIV o CLASS 'row h-100'

DIV o CLASS 'col-12 col-md-3 left-pane'

DIV o ID 'example-table' STYLE 'box-shadow: 5px 2px 8px rgba(0,0,0,0.35); margin: 5px; padding: 5px; border-radius: 4px;'


DIV o STYLE 'margin-top:5px;'
BUTTON ID 'btn_add'  ICON '<div style="display:flex;flex-direction:column;align-items:center;"><i class="fas fa-plus text-primary" style="font-size:16px;"></i><span style="font-size:9px;color:#6c757d;margin-top:3px;">Adicionar</span></div>' ACTION 'nuevocilindro' GRID 0 CLASS 'border-0' STYLE 'margin-right:4px;border:0;background:transparent;padding:2px 4px;' OF o
BUTTON ID 'btn_edit'   ICON '<div style="display:flex;flex-direction:column;align-items:center;"><i class="fas fa-edit text-primary" style="font-size:16px;"></i><span style="font-size:9px;color:#6c757d;margin-top:3px;">Editar</span></div>' ACTION 'editar_cliente' GRID 0 CLASS 'border-0' STYLE 'margin-right:4px;border:0;background:transparent;padding:2px 4px;' OF o
BUTTON ID 'btn_delete'   ICON '<div style="display:flex;flex-direction:column;align-items:center;"><i class="fas fa-trash text-primary" style="font-size:16px;"></i><span style="font-size:9px;color:#6c757d;margin-top:3px;">Borrar</span></div>' ACTION 'eliminar_cliente' GRID 0 CLASS 'border-0' STYLE 'margin-right:4px;border:0;background:transparent;padding:2px 4px;' OF o
BUTTON ID 'btn_export'   ICON '<div style="display:flex;flex-direction:column;align-items:center;"><i class="fas fa-file-export text-primary" style="font-size:16px;"></i><span style="font-size:9px;color:#6c757d;margin-top:3px;">Exportar</span></div>' ACTION 'exportar_cliente' GRID 0 CLASS 'border-0' STYLE 'margin-right:4px;border:0;background:transparent;padding:2px 4px;' OF o
ENDDIV o


ROWGROUP o
GET ID 'cFiltroMovimiento' VALUE '' ;
    PLACEHOLDER	 'Ingrese el nombre del cliente o # de documento...' ;
    BUTTON '<i class="fas fa-search"></i>' ;
    ACTION 'filtrar_movimiento' ;
    GRID 12 OF o
ENDROW o


// Usar el componente de tabla
HTML o FILE 'components/tabla_browse.html' PARAMS o, 'movimientos', aColumnas, aData, aEvents, aOptions
HTML o FILE 'components/barra_paginacion.html' PARAMS o, 'nav', 0
ENDDIV o
ENDDIV o

DIV o CLASS 'col-12 col-md-9 p-2 right-pane'

HTML o FILE 'components/header_titulo_botones.html' PARAMS o, 'Ingreso de Cilindros', 'fas fa-wrench',

DIV o STYLE 'box-shadow: 5px 2px 8px rgba(0,0,0,0.35); margin: 5px; padding: 5px; border-radius: 4px;'
ROW o CLASS 'gx-3'
COL o GRID 6
ROWGROUP o
GET ID 'cCliente' GRID 12;
    VALUE '';
    PROMPT 'Cliente';
    VALID 'seleccionar_cliente';
    PLACEHOLDER 'Ingrese el código del cliente';
    BUTTON '<i class="fas fa-search"></i>';
    ACTION 'ayuda_cliente';
    OF o
GET MEMO ID 'cInfoCliente' GRID 12;
    VALUE 'Debe seleccionar un cliente para ver su información';
    ROWS 4 STYLE 'resize: none; margin-top: 5px;';
    DISABLED;
    OF o
ENDROW o
ENDCOL o

COL o GRID 6
ROWGROUP o
GET ID 'cOrden'  GRID 12;
    LABEL 'Orden # :';
    PLACEHOLDER 'Número de orden';
    DISABLED;
    OF o
GET ID 'cFecha'   GRID 12;
    VALUE '';
    LABEL 'Fecha :';
    TYPE 'date';
    DISABLED;
    OF o
SELECT oSelect ID 'cTipo' GRID 12;
    PROMPT 'LLenado', 'Reparación', 'Traslado';
    VALUES 'L', 'R', 'T';
    LABEL 'Tipo :';
    OF o
ENDROW o
ENDCOL o
ENDROW o
ENDDIV o

DIV o STYLE 'box-shadow: 5px 2px 8px rgba(0,0,0,0.35); margin: 5px; padding: 5px; border-radius: 4px;'
// tabla sencilla: datos de prueba de cilindros
HTML o FILE 'components/tabla_browse.html' PARAMS o, 'cilindros', bColumnas, bData, bOptions

ROWGROUP o CLASS 'mt-2'
GET ID 'cNuevoCilindro' VALUE '' ;
    VALID 'agregar_cilindro' ;
    PLACEHOLDER 'Ingrese el código del cilindro...' ;
    BUTTON '<i class="fas fa-search"></i>' ;
    ACTION 'ayuda_cilindro' ;
    GRID 6 OF o
ENDROW o

// Campo oculto para mantener el array de cilindros como JSON
GET ID 'cilindros_json' VALUE '' HIDDEN OF o

ENDDIV o
ENDDIV o

ENDDIV o
ENDFORM o	


HTML o 
<script>
    // Formateadores globales (Tabulator los busca por nombre)
    function editbutton() { return '<i class="fas fa-pencil-alt" style="color:blue;"></i>'; }
    function deletebutton() { return '<i class="fas fa-trash-alt" style="color:red;"></i>'; }

    // Obtener tabla por sufijo (movimientos / cilindros)
    function getTable(suffix) {
        var t = Tabulator.findTable('#home_cilindros-' + suffix);
        return (t && t.length) ? t[0] : null;
    }

    // Actualiza el campo oculto con el JSON actual de cilindros
    function setCilindrosJson(data) {
        var json = JSON.stringify(data || []);
        var $el = $("[id$='cilindros_json'], [name='cilindros_json']").first();
        if ($el.length) {
            $el.val(json);
            console.log('Actualizado cilindros_json, elementos encontrados:', $el.length);
        } else {
            console.warn('Input cilindros_json no encontrado en el DOM.');
        }
    }

    // Enviar petición para agregar un cilindro (incluye datos actuales de la tabla)
    function sendAddCilindro() {
        var $input = $("[id$='cNuevoCilindro']").first();
        if (!$input.length) { console.warn('Input cNuevoCilindro no encontrado'); return; }
        var cVal = $input.val() || '';
        if (!cVal) { console.warn('cNuevoCilindro vacío'); return; }
        var t = getTable('cilindros');
        var cilindrosData = t ? t.getData() : [];
        var params = { cNuevoCilindro: cVal, cilindros_json: JSON.stringify(cilindrosData) };
        try { MsgApi('api_home_cilindros', 'agregar_cilindro', params, 'home_cilindros'); }
        catch (e) { console.error('Error llamando MsgApi', e); }
    }

    // Inicialización de bindings
    $(function () {
        var movimientos = getTable('movimientos');
        var cilindros = getTable('cilindros');

        if (movimientos) {
            movimientos.on('tableBuilt', function () {
                setTimeout(function () {
                    var rows = movimientos.getRows();
                    if (!rows.length) return;
                    try {
                        rows[0].select();
                        rows[0].getElement().dispatchEvent(new Event('click'));
                        var $dlg = $('#' + movimientos.element.id).parents('[data-dialog]');
                        var id_parent = $dlg.length ? $dlg.attr('id') : null;
                        var cApi = id_parent ? $('#' + id_parent).data('api') : null;
                        if (cApi && id_parent) {
                            MsgApi(cApi, 'sincronizar', { row: rows[0].getData() }, id_parent);
                        } else {
                            console.warn('No se encontró api/dialog padre para enviar evento rowClick');
                        }
                    } catch (e) { console.error('Error enviando evento a la API:', e); }
                }, 300);
            });
        }

        if (cilindros) {
            cilindros.on('tableBuilt', function () { try { setCilindrosJson(cilindros.getData()); } catch (e) { console.warn('No se pudo obtener datos en tableBuilt', e); } });
            cilindros.on('dataChanged', function (data) { setCilindrosJson(data); });
        }

        // Enter -> enviar nuevo cilindro
        $(document).on('keydown', "[id$='cNuevoCilindro']", function (e) { if (e.key === 'Enter') { e.preventDefault(); sendAddCilindro(); } });
    });
</script>
    ENDTEXT

    INIT DIALOG oWeb RETURN

    ?>