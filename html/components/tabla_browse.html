<?prg
// Componente de Tabla Browse
// Parámetros: 
//   - oFormulario: Objeto del formulario padre
//   - cID: ID del browse
//   - aColumnas: Array con configuración de columnas
//   - aData: Datos para la tabla
//   - aEvents: Array con eventos personalizados (opcional)
//   - hOpciones: Hash con opciones adicionales (opcional)

local oForm := pvalue(1)
local cID := pvalue(2)
local aColumnas := pvalue(3)
local aData := pvalue(4)
local aEvents := pvalue(5)  // Eventos opcionales
local tmp := pvalue(6)
local aCol, i, hColCfg
local hOpciones := {=>}

// Si aEvents es NIL o no es array, inicializar como array vacío
if valtype(aEvents) != 'A'
    // Si el 5º parámetro no es array, probablemente son las opciones
    tmp := aEvents
    aEvents := {}
endif
// Normalizar opciones: aceptar hash o array de pares { {key, val}, ... }

if valtype( tmp ) == 'H'
    hOpciones := tmp
elseif valtype( tmp ) == 'A'
    // convertir array de pares a hash
    for i := 1 to len( tmp )
        if valtype( tmp[i] ) == 'A' .and. len( tmp[i] ) >= 2
            hOpciones[ tmp[i][1] ] := tmp[i][2]
        endif
    next
endif


if !('index' $ hOpciones)
    hOpciones['index'] := 'ROW_ID'
endif
if !('selectable' $ hOpciones)
    hOpciones['selectable'] := .T.
endif
if !('selectableRollingSelection' $ hOpciones)
    hOpciones['selectableRollingSelection'] := .T.
endif
if !('selectableRangeMode' $ hOpciones)
    hOpciones['selectableRangeMode'] := "click"
endif
if !('movableColumns' $ hOpciones)
    hOpciones['movableColumns'] := .F.
endif


// Ya no definimos eventos por defecto
// Los eventos vienen completamente de la vista que llama al componente

DEFINE BROWSE oBrw ID cID OPTIONS hOpciones EVENTS aEvents OF oForm
    for i := 1 to len(aColumnas)
        aCol := aColumnas[i]
        // ensure aCol is a hash
        if valtype(aCol) != 'H'
            aCol := { 'title' => '', 'field' => '' }
        endif

        // Build column config safely, only adding keys that exist
        hColCfg := {=>}
        hColCfg['title'] := aCol['title']
        hColCfg['field'] := aCol['field']

        if ('width' $ aCol)
            hColCfg['width'] := aCol['width']
        endif
        if ('widthGrow' $ aCol)
            hColCfg['widthGrow'] := aCol['widthGrow']
        endif
        if ('minWidth' $ aCol)
            hColCfg['minWidth'] := aCol['minWidth']
        endif
        if ('formatter' $ aCol)
            hColCfg['formatter'] := aCol['formatter']
        endif
        if ('hozAlign' $ aCol)
            hColCfg['hozAlign'] := aCol['hozAlign']
        endif

        // default behaviour for resizable
        hColCfg['resizable'] := .f.
        if ('sortable' $ hOpciones) .and. !hOpciones['sortable']
            hColCfg['headerSort'] := .f.
        endif

        COL oCol TO oBrw CONFIG hColCfg
    next
    INIT BROWSE oBrw DATA aData

RETU ''
?>